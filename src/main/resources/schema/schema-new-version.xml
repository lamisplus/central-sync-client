<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
    <changeSet failOnError="false" author="Emeka Ilozue" id="202309120431">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM pg_attribute
                WHERE attrelid = (SELECT oid FROM pg_class WHERE relname = 'sync_history_tracker');
            </sqlCheck>
        </preConditions>
        <sql>
            DELETE FROM sync_history;
        </sql>
    </changeSet>


    <changeSet failOnError="false" author="Emeka Ilozue" id="202309120432">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM pg_attribute
                WHERE attrelid = (SELECT oid FROM pg_class WHERE relname = 'sync_history')
                  AND attname = 'gen_key';
            </sqlCheck>
        </preConditions>
        <sql>
            ALTER TABLE IF EXISTS sync_history ADD COLUMN uuid uuid NOT NULL;
            ALTER TABLE IF EXISTS sync_history ADD CONSTRAINT uuid_unique UNIQUE (uuid);
            ALTER TABLE IF EXISTS sync_history ADD COLUMN gen_key character varying;
        </sql>
    </changeSet>

    <changeSet failOnError="false" author="Emeka" id="202309120433">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="sync_history_tracker"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS sync_history_tracker
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                sync_history_id bigint NOT NULL,
                file_name character varying NOT NULL,
                record_size character varying NOT NULL,
                status character varying ,
                time_created timestamp without time zone,
                archived integer,
                facility_id bigint,
                uuid uuid,
                sync_history_uuid uuid,
                CONSTRAINT sync_history_tracker_pk PRIMARY KEY (id),
                CONSTRAINT sync_history_id_fk FOREIGN KEY (sync_history_id)
                REFERENCES sync_history (id) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION,
                CONSTRAINT sync_history_uuid_fk FOREIGN KEY (sync_history_uuid)
                REFERENCES sync_history (uuid) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION
                NOT VALID
                );
        </sql>
    </changeSet>

    <changeSet failOnError="false" author="Emeka" id="202309120434">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="sync_config"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS sync_config
            (
                id uuid NOT NULL,
                name character varying(255) ,
                version character varying(255) ,
                release_date timestamp without time zone,
                active boolean,
                upload_date time without time zone,
                CONSTRAINT sync_config_pkey PRIMARY KEY (id)
                );
        </sql>
    </changeSet>

    <changeSet failOnError="false" author="Emeka" id="202309120435">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="sync_config_module"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS sync_config_module
            (
                id uuid NOT NULL,
                module_name character varying(255) ,
                min_version character varying(255) ,
                config_id uuid NOT NULL,
                max_version character varying ,
                CONSTRAINT config_module_pkey PRIMARY KEY (id),
                CONSTRAINT fk_config_module_on_config_id FOREIGN KEY (config_id)
                REFERENCES sync_config (id) MATCH SIMPLE
                ON UPDATE NO ACTION
                ON DELETE NO ACTION
                );
        </sql>
    </changeSet>

    <changeSet failOnError="false" author="Emeka" id="202309120436">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="sync_config_table"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS sync_config_table
            (
                id uuid NOT NULL,
                table_name character varying(255) ,
                exclude_columns character varying(4000) ,
                update_column character varying(255) ,
                config_module_id uuid NOT NULL,
                has_facility_id boolean,
                CONSTRAINT sync_config_table_pkey PRIMARY KEY (id),
                CONSTRAINT fk_config_table_on_config_module_id FOREIGN KEY (config_module_id)
                REFERENCES sync_config_module (id) MATCH SIMPLE
                ON UPDATE NO ACTION
                ON DELETE NO ACTION
                );
        </sql>
    </changeSet>

    <changeSet failOnError="false" author="Emeka" id="202309120437">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="sync_facility_app_key"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS sync_facility_app_key
            (
                id uuid NOT NULL,
                facility_id integer,
                app_key character varying(2000) ,
                server_url character varying(500) ,
                CONSTRAINT sync_facility_app_key_pkey PRIMARY KEY (id)
                );
        </sql>
    </changeSet>
</databaseChangeLog>